various tests and fixes
|-refactoring production code
|-formatting, missing semi colons