various tests and fixes
|-refactoring production code